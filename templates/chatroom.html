<!DOCTYPE html>
<html lang="en">
<head>
    <!-- icon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- socketio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" integrity="sha512-v8ng/uGxkge3d1IJuEo6dJP8JViyvms0cly9pnbfRxT6/31c3dRWxIiwGnMSWwZjHKOuY3EVmijs7k1jz/9bLA==" crossorigin="anonymous"></script>
    
    <script type="text/javascript"> var myRoomID = "{{room_id}}"; var myName = "{{display_name}}"; </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potato Meet</title>
</head>
<body>
    <h2>Welcome to {{room_id}}</h2>
    <h4>You have joined as {{display_name}}</h4>
    <p>Ask your friends to join using room id: {{room_id}}</p>
    <hr>

    <div id="video_grid" class="grid-container">

        <div id="control_box" class="control-box"></div>
    </div>
    

    <div id="log"></div>
</body>

<script type="text/javascript">
    var videoGrid = document.getElementById("video_grid");
    function addVideoElement(element_id, display_name)
    {
        let wrapper_div = document.createElement("div");
        let vid_wrapper = document.createElement("div");
        let vid = document.createElement("video");
        let name_text = document.createElement("div");

        wrapper_div.id = "div_"+element_id;
        wrapper_div.className = "grid-item";
        vid_wrapper.className = "vid-wrapper";
        vid.id = "vid_"+element_id;
        vid.autoplay = true;        
        name_text.className = "display-name";
        name_text.innerText = display_name;

        vid_wrapper.appendChild(vid)
        wrapper_div.appendChild(vid_wrapper);
        wrapper_div.appendChild(name_text);
        videoGrid.appendChild(wrapper_div);
    }
    function removeVideoElement(element_id)
    {
        document.getElementById("div_"+element_id).remove();
    }

    function getVideoObj(element_id)
    {
        return document.getElementById("vid_"+element_id);
    }
    
    var myID;
    var _peer_list = {};
    var logger = document.getElementById("log");
    addVideoElement("local_vid", myName);
    var myVideo = getVideoObj("local_vid");
    myVideo.muted = true;
    myVideo.onloadeddata = ()=>{console.log("W,H: ", myVideo.videoWidth, ", ", myVideo.videoHeight);};

    var log_bttn = document.createElement("button");
    log_bttn.innerText = "click";
    log_bttn.onclick = log_user_list;
    document.body.appendChild(log_bttn);
    

    var mediaConstraints = {
        audio: true, // We want an audio track
        video: {
            height: 360
        } // ...and we want a video track
    };
    
    // socketio setup
    var protocol = window.location.protocol;
    var socket = io.connect(protocol + '//' + document.domain + ':' + location.port);

    socket.on("connect", ()=>{
        console.log("socket connected....");
        socket.emit("join-room", {"room_id": myRoomID});
    });

    
    socket.on("user-connect", (data)=>{
        console.log("user-connect ", data);
        let peer_id = data["sid"];
        let display_name = data["name"];
        _peer_list[peer_id] = undefined; // add new user to user list
        log_user_list();
        addVideoElement(peer_id, display_name);
    });
    socket.on("user-disconnect", (data)=>{
        console.log("user-disconnect ", data);
        let peer_id = data["sid"];
        delete _peer_list[peer_id]; // remove user from user list
        log_user_list();
        removeVideoElement(peer_id);
    });
    socket.on("user-list", (data)=>{
        console.log("user list recvd ", data);
        myID = data["my_id"];
        if( "list" in data) // not the first to connect to room
        {
            let recvd_list = data["list"];  

            // add existing users to user list
            for(peer_id in recvd_list)
            {
                display_name = recvd_list[peer_id];
                _peer_list[peer_id] = undefined;
                addVideoElement(peer_id, display_name);
            }            

            log_user_list();

            start_webrtc();
        }
        else // first user to connect
        {
            navigator.mediaDevices.getUserMedia(mediaConstraints)
            .then((stream)=>{
                myVideo.srcObject = stream;                
            })
            .catch((e)=>{
                alert("Error! Unable to start video! ", e);
            });
        }

        
    });

    function log_user_list()
    {
        logger.innerText = "";
        for(let key in _peer_list)
        {
            logger.innerText += `${key}:${_peer_list[key]}\n`;
        }
    }

    //---------------webrtc--------------------

    

    var PC_CONFIG = {
        iceServers: [
            {
                urls: ['stun:stun.l.google.com:19302', 
                        'stun:stun1.l.google.com:19302',
                        'stun:stun2.l.google.com:19302',
                        'stun:stun3.l.google.com:19302',
                        'stun:stun4.l.google.com:19302'
                    ]
            },
        ]
    };

    function log_error(e){console.log("[ERROR] ", e);}
    function sendViaServer(data){socket.emit("data", data);}

    socket.on("data", (msg)=>{
        switch(msg["type"])
        {
            case "offer":
                handleOfferMsg(msg);
                break;
            case "answer":
                handleAnswerMsg(msg);
                break;
            case "new-ice-candidate":
                handleNewICECandidateMsg(msg);
                break;
        }
    });

    function start_webrtc()
    {
        navigator.mediaDevices.getUserMedia(mediaConstraints)
        .then((stream)=>{
            myVideo.srcObject = stream;

            // send offer to all other members
            for(let peer_id in _peer_list)
            {
                invite(peer_id);
            }
        })
        .catch((e)=>{
            console.log("Error! Unable to start video! ", e);
        });
    }

    function invite(peer_id)
    {
        if(_peer_list[peer_id]){console.log("[Not supposed to happen!] Attempting to start a connection that already exists!")}
        else if(peer_id === myID){console.log("[Not supposed to happen!] Trying to connect to self!");}
        else
        {
            console.log(`Creating peer connection for <${peer_id}> ...`);
            createPeerConnection(peer_id);

            let local_stream = myVideo.srcObject;
            local_stream.getTracks().forEach((track)=>{_peer_list[peer_id].addTrack(track, local_stream);});
        }
    }

    function createPeerConnection(peer_id)
    {
        _peer_list[peer_id] = new RTCPeerConnection(PC_CONFIG);

        _peer_list[peer_id].onicecandidate = (event) => {handleICECandidateEvent(event, peer_id)};
        _peer_list[peer_id].ontrack = (event) => {handleTrackEvent(event, peer_id)};
        _peer_list[peer_id].onnegotiationneeded = () => {handleNegotiationNeededEvent(peer_id)};
        // myPeerConnection.onremovetrack = handleRemoveTrackEvent;
        // myPeerConnection.oniceconnectionstatechange = handleICEConnectionStateChangeEvent;
        // myPeerConnection.onicegatheringstatechange = handleICEGatheringStateChangeEvent;
        // myPeerConnection.onsignalingstatechange = handleSignalingStateChangeEvent;
    }

    
    
    function handleNegotiationNeededEvent(peer_id)
    {
        _peer_list[peer_id].createOffer()
        .then((offer)=>{return _peer_list[peer_id].setLocalDescription(offer);})
        .then(()=>{
            console.log(`sending offer to <${peer_id}> ...`);
            sendViaServer({
                "sender_id": myID,
                "target_id": peer_id,
                "type": "offer",
                "sdp": _peer_list[peer_id].localDescription
            });
        })
        .catch(log_error);
    } 

    function handleOfferMsg(msg)
    {   
        peer_id = msg['sender_id'];

        console.log(`offer recieved from <${peer_id}>`);
        
        createPeerConnection(peer_id);
        let desc = new RTCSessionDescription(msg['sdp']);
        _peer_list[peer_id].setRemoteDescription(desc)
        .then(()=>{
            let local_stream = myVideo.srcObject;
            local_stream.getTracks().forEach((track)=>{_peer_list[peer_id].addTrack(track, local_stream);});
        })
        .then(()=>{return _peer_list[peer_id].createAnswer();})
        .then((answer)=>{return _peer_list[peer_id].setLocalDescription(answer);})
        .then(()=>{
            sendViaServer({
                "sender_id": myID,
                "target_id": peer_id,
                "type": "answer",
                "sdp": _peer_list[peer_id].localDescription
            });
        })
        .catch(log_error);
    }

    function handleAnswerMsg(msg)
    {
        peer_id = msg['sender_id'];
        console.log(`answer recieved from <${peer_id}>`);
        let desc = new RTCSessionDescription(msg['sdp']);
        _peer_list[peer_id].setRemoteDescription(desc)
    }


    
    function handleICECandidateEvent(event, peer_id)
    {
        if(event.candidate){
            sendViaServer({
                "sender_id": myID,
                "target_id": peer_id,
                "type": "new-ice-candidate",
                "candidate": event.candidate
            });
        }
    }

    function handleNewICECandidateMsg(msg)
    {
        var candidate = new RTCIceCandidate(msg.candidate);
        _peer_list[msg["sender_id"]].addIceCandidate(candidate)
        .catch(log_error);
    }

    
    function handleTrackEvent(event, peer_id)
    {
        console.log(`track event recieved from <${peer_id}> : ${event}`);
        
        if(event.streams)
        {
            getVideoObj(peer_id).srcObject = event.streams[0];
        }
    }




</script>

<style type="text/css">
    body{
        background-color: rgb(59, 63, 62);
        color: rgb(250, 250, 250);
    }
    .grid-container{
        display: grid;        
        
        grid-template-columns: auto auto;
        grid-template-rows: auto auto 200px;
        gap: 0.8rem;
        /* background-color: rgb(255, 0, 0); */
        /* border: 2px solid rgb(0, 0, 0); */

        margin-left: 0.5rem;
        margin-right: 0.5rem;
        
        /* overflow-y: scroll; */
    }
    .grid-item {
        
        background-color: rgb(78, 78, 78);
        /* border: 2px solid rgb(0,255,255); */
        padding: 6px;
        border-radius: 3px;
        text-align: center;
    }
    .vid-wrapper
    {
        background-color: rgb(20, 20, 20);
    }
    .vid-wrapper video{
        max-width: 45vw;
        max-height: 280px;        
    }
    .grid-item .display-name{
        font-weight:lighter;
        font-size: 20px;
        padding: 3px;
    }

    #control_box{
        grid-area: 3 / 1 / 4 / 2;
        background-color: rgb(48, 52, 75);
        /* width: 50vw; */
    }
    #div_local_vid{
        grid-area: 3 / 2 / 4 / 3;
        background-color: rgb(48, 52, 75);
    }
    #div_local_vid video{        
        max-width: 50vw;
        max-height: 150px;

    }

</style>

</html>